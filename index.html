<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Voice Room</title>
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
  <style>
    body {
      margin: 0;
      padding: 8px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: #ffffff;
      color: #222;
    }
    .wrapper {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }
    h2 {
      margin: 0 0 4px 0;
      font-size: 18px;
    }
    .buttons {
      display: flex;
      gap: 8px;
    }
    button {
      border: none;
      border-radius: 18px;
      padding: 6px 14px;
      font-size: 14px;
      cursor: pointer;
    }
    .join {
      background: #00b894;
      color: white;
      width: 90px;
    }
    .leave {
      background: #eeeeee;
      color: #444;
      width: 90px;
    }
    .room-label {
      font-size: 12px;
      color: #777;
    }
  </style>
</head>

<body>
<div class="wrapper">

    <h2>Voice Room lÃ¤uft ðŸš€</h2>
    <div class="room-label">Channel: testroom</div>

    <!-- Live User Liste -->
    <h3>ðŸ‘¥ Teilnehmer: <span id="participantCount">0</span></h3>

<ul id="participants"></ul>

<button id="moreButton"
        onclick="toggleMore()"
        style="display:none; margin-top:4px; font-size:12px;">
  Alle anzeigen
</button>


    <div class="buttons">
        <button class="join" onclick="join()">Beitreten</button>
        <button class="leave" onclick="leave()">Verlassen</button>
    </div>
</div>

<script>
// ==== Agora-Konfiguration â€“ HIER DEINE WERTE EINTRAGEN ====
const appId  = 'a393d43e6ca144c7a9f3146ffa414aac';          // <- deine App ID aus Agora
const token  = '007eJxTYIguO7XkTEW4TkTPz7/vvT447lN44Ppdv/kmw6vayNIfywwVGBKNLY1TTIxTzZITDU1Mks0TLdOMDU3M0tISTQxNEhOTv742zGwIZGSonnKPkZEBAkF8DoaS1OKSovz8XAYGAMFXJL8=';            // <- dein (Temp-)Token
const channel = 'testroom';                  // <- dein Test-Channelname

// ==== Agora-Client ====
const client = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
let localAudioTrack = null;
let localUid = null;

// ==== Teilnehmer-Verwaltung ====
const participants = new Map(); // Map<uid, true>

const listEl  = document.getElementById('participants');
const countEl = document.getElementById('participantCount');
const moreBtn = document.getElementById('moreButton');

let showAll = false;        // ob alle angezeigt werden sollen
const maxToShow = 3;        // wie viele Teilnehmer standardmÃ¤ÃŸig gezeigt werden

function renderParticipants() {
  const uids = Array.from(participants.keys());

  // Anzahl anzeigen
  countEl.textContent = uids.length.toString();

  // Liste leeren
  listEl.innerHTML = '';

  // Nur erste maxToShow oder alle
  const toShow = showAll ? uids : uids.slice(0, maxToShow);

  toShow.forEach(uid => {
    const li = document.createElement('li');
    li.textContent = 'User ' + uid;
    listEl.appendChild(li);
  });

  // Button "Alle anzeigen / Weniger anzeigen"
  if (uids.length > maxToShow) {
    moreBtn.style.display = 'inline-block';
    moreBtn.textContent = showAll
      ? 'Weniger anzeigen'
      : `Alle anzeigen (${uids.length})`;
  } else {
    moreBtn.style.display = 'none';
  }
}

function toggleMore() {
  showAll = !showAll;
  renderParticipants();
}

// ==== Funktionen: Raum beitreten / verlassen ====
async function join() {
  try {
    // User dem Channel beitreten lassen
    localUid = await client.join(appId, channel, token || null, null);

    // lokalen User in die Liste aufnehmen
    participants.set(localUid, true);
    renderParticipants();

    // Mikrofonspur erstellen + verÃ¶ffentlichen
    localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
    await client.publish(localAudioTrack);

    alert('Du bist jetzt im Voice Room ðŸŽ§');
  } catch (e) {
    alert('âŒ Fehler beim Join: ' + e.message);
  }
}

async function leave() {
  try {
    // Lokale Audiotrack stoppen / freigeben
    if (localAudioTrack) {
      localAudioTrack.stop();
      localAudioTrack.close();
      localAudioTrack = null;
    }

    // Lokalen User aus der Teilnehmerliste entfernen
    if (localUid !== null) {
      participants.delete(localUid);
      localUid = null;
      renderParticipants();
    }

    await client.leave();
    alert('Du hast den Raum verlassen');
  } catch (e) {
    alert('âŒ Fehler beim Verlassen: ' + e.message);
  }
}

// ==== Remote-Teilnehmer behandeln ====

// Wenn ein anderer User etwas publiziert (z.B. Audio)
client.on('user-published', async (user, mediaType) => {
  try {
    await client.subscribe(user, mediaType);

    if (mediaType === 'audio') {
      const remoteAudioTrack = user.audioTrack;
      remoteAudioTrack.play();  // du hÃ¶rst ihn
    }

    // Remote-User zur Teilnehmerliste hinzufÃ¼gen
    participants.set(user.uid, true);
    renderParticipants();
  } catch (e) {
    console.error('Fehler bei user-published:', e);
  }
});

// Wenn ein User den Raum verlÃ¤sst
client.on('user-left', (user) => {
  participants.delete(user.uid);
  renderParticipants();
});
</script>

</body>
</html>
