<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Voice Room</title>
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
  <style>
    body {
      margin: 0;
      padding: 8px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: #ffffff;
      color: #222;
    }
    .wrapper {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }
    h2 {
      margin: 0 0 4px 0;
      font-size: 18px;
    }
    .buttons {
      display: flex;
      gap: 8px;
    }
    button {
      border: none;
      border-radius: 18px;
      padding: 6px 14px;
      font-size: 14px;
      cursor: pointer;
    }
    .join {
      background: #00b894;
      color: white;
      width: 90px;
    }
    .leave {
      background: #eeeeee;
      color: #444;
      width: 90px;
    }
    .room-label {
      font-size: 12px;
      color: #777;
    }
  </style>
</head>

<body>
<div class="wrapper">

    <h2>Voice Room l√§uft üöÄ</h2>
    <div class="room-label">Channel: testroom</div>

    <!-- Live User Liste -->
    <h3>üë• Teilnehmer:</h3>
    <ul id="userList"></ul>

    <div class="buttons">
        <button class="join" onclick="join()">Beitreten</button>
        <button class="leave" onclick="leave()">Verlassen</button>
    </div>
</div>

<script>
/* Agora Keys */
const appId = "a393d43e6ca144c7a9f3146ffa414aac";
const token = "007eJxTYIguO7XkTEW4TkTPz7/vvT447lN44Ppdv/kmw6vayNIfywwVGBKNLY1TTIxTzZITDU1Mks0TLdOMDU3M0tISTQxNEhOTv742zGwIZGSonnKPkZEBAkF8DoaS1OKSovz8XAYGAMFXJL8=";
const channel = "testroom";

const client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
let localAudioTrack;
let users = {}; // Speichert Teilnehmer

async function join() {
    try {
        await client.join(appId, channel, token, null);

        // Mikrofon aktivieren
        localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
        await client.publish(localAudioTrack);

        alert("üé§ Du bist dem Raum beigetreten!");

        client.on("user-joined", handleUserJoin);
        client.on("user-left", handleUserLeave);

    } catch (e) { alert("‚ùå Fehler: " + e.message); }
}

async function leave() {
    try {
        if(localAudioTrack){
            localAudioTrack.stop();
            localAudioTrack.close();
        }
        client.leave();
        alert("üëã Raum verlassen");
        document.getElementById("userList").innerHTML = "";
    } catch (e) { alert("‚ùå Fehler: " + e.message); }
}

// User Events -----------------------

function handleUserJoin(user) {
    users[user.uid] = user;
    updateUserList();
}

function handleUserLeave(user) {
    delete users[user.uid];
    updateUserList();
}

function updateUserList() {
    const list = document.getElementById("userList");
    list.innerHTML = "";
    for (let id in users) {
        let li = document.createElement("li");
        li.textContent = "User " + id;
        list.appendChild(li);
    }
}
</script>
</body>
</html>
